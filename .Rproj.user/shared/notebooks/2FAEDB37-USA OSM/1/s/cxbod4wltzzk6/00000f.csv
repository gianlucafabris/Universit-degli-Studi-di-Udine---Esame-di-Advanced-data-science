"0","#leggi nodi"
"0","state_dirs = list.dirs(""data/roads"", recursive = FALSE)"
"0","nodes = map(state_dirs, ~ {"
"0","  csv_path = file.path(.x, ""nodes.csv"")"
"0","  if(file.exists(csv_path)){"
"0","    read_csv(csv_path, show_col_types = FALSE)"
"0","  }else{"
"0","    NULL"
"0","  }"
"0","})"
"0","names(nodes) = basename(state_dirs)"
"0",""
"0","#leggi archi"
"0","state_dirs = list.dirs(""data/roads"", recursive = FALSE)"
"0","edges = map(state_dirs, ~ {"
"0","  csv_path = file.path(.x, ""edges.csv"")"
"0","  if(file.exists(csv_path)){"
"0","    read_csv(csv_path, show_col_types = FALSE)"
"0","  }else{"
"0","    NULL"
"0","  }"
"0","})"
"0","names(edges) = basename(state_dirs)"
"0","global_csv_path = file.path(""data/roads"", ""edges.csv"")"
"0","edges[[""global""]] = read_csv(global_csv_path, show_col_types = FALSE)"
"0",""
"0","#pulizia dati"
"0","words_to_remove = c(""County"", ""Borough"", ""Parish"", ""Planning Region"")"
"0",""
"0","nodes$MD = nodes$MD %>%"
"0","  mutate(county = ifelse(county == ""Baltimore"", paste0(county, "" City""), county))"
"0","edges$MD = edges$MD %>%"
"0","  mutate(county1 = ifelse(county1 == ""Baltimore"", paste0(county1, "" City""), county1), county2 = ifelse(county2 == ""Baltimore"", paste0(county2, "" City""), county2))"
"0",""
"0","nodes$MO = nodes$MO %>%"
"0","  mutate(county = ifelse(county == ""Saint Louis"", paste0(county, "" City""), county))"
"0","edges$MO = edges$MO %>%"
"0","  mutate(county1 = ifelse(county1 == ""Saint Louis"", paste0(county1, "" City""), county1), county2 = ifelse(county2 == ""Saint Louis"", paste0(county2, "" City""), county2))"
"0",""
"0","nodes$VA = nodes$VA %>%"
"0","  mutate(county = ifelse(county == ""Roanoke"", paste0(county, "" City""), county))"
"0","edges$VA = edges$VA %>%"
"0","  mutate(county1 = ifelse(county1 == ""Roanoke"", paste0(county1, "" City""), county1), county2 = ifelse(county2 == ""Roanoke"", paste0(county2, "" City""), county2))"
"0",""
"0","nodes$VA = nodes$VA %>%"
"0","  mutate(county = ifelse(county == ""Franklin"", paste0(county, "" City""), county))"
"0","edges$VA = edges$VA %>%"
"0","  mutate(county1 = ifelse(county1 == ""Franklin"", paste0(county1, "" City""), county1), county2 = ifelse(county2 == ""Franklin"", paste0(county2, "" City""), county2))"
"0",""
"0","nodes = map(nodes, ~ .x %>%"
"0","  mutate(across(c(county, city_name), ~ str_remove_all(.x, str_c(words_to_remove, collapse = ""|"")) %>% str_trim()))"
"0",")"
"0",""
"0","edges = map(edges, ~ if(nrow(.x) > 0 && ncol(.x) > 0){"
"0","    .x %>%"
"0","      mutate(across(c(county1, county2), ~ str_remove_all(.x, str_c(words_to_remove, collapse = ""|"")) %>% str_trim()))"
"0","  }else{"
"0","    .x"
"0","  }"
"0",")"
"0",""
"0","#distanze"
"0","edges[1:(length(edges) - 1)] = map2(edges[1:(length(edges) - 1)], nodes, ~ {"
"0","  if(nrow(.x) > 0){"
"0","    .x %>%"
"0","      left_join(.y, by = c(""county1"" = ""county"")) %>%"
"0","      rename(y_u = lat, x_u = lon) %>%"
"0","      left_join(.y, by = c(""county2"" = ""county"")) %>%"
"0","      rename(y_v = lat, x_v = lon) %>%"
"0","      mutate(dist = sqrt((x_v - x_u)^2 + (y_v - y_u)^2)) %>%"
"0","      select(county1, county2, dist)"
"0","  }else{"
"0","    .x"
"0","  }"
"0","})"
"0",""
"0","edges$global = edges$global %>%"
"0","  left_join(states, by = c(""state1"" = ""name"")) %>%"
"0","  rename(state1_abbr = abbr) %>%"
"0","  left_join(states, by = c(""state2"" = ""name"")) %>%"
"0","  rename(state2_abbr = abbr) %>%"
"0","  select(-state1, -state2) %>%"
"0","  rename(state1 = state1_abbr, state2 = state2_abbr)"
"0",""
"0","edges$global = edges$global %>%"
"0","  left_join(bind_rows(nodes, .id = ""state""), by = c(""state1"" = ""state"", ""county1"" = ""county"")) %>%"
"0","  rename(y_u = lat, x_u = lon) %>%"
"0","  left_join(bind_rows(nodes, .id = ""state""), by = c(""state2"" = ""state"", ""county2"" = ""county"")) %>%"
"0","  rename(y_v = lat, x_v = lon) %>%"
"0","  mutate(dist = sqrt((x_v - x_u)^2 + (y_v - y_u)^2)) %>%"
"0","  select(state1, county1, state2, county2, dist)"
"0",""
"0","#creazione grafi"
"0","create_state_graph = function(state_nodes, state_edges){"
"0","  if(nrow(state_edges) == 0){"
"0","    graph = graph_from_data_frame(d = data.frame(u = character(0), v = character(0)), vertices = state_nodes %>% select(county, city_name, lat, lon) %>% rename(y = lat, x = lon), directed = FALSE)"
"0","    return(graph)"
"0","  }else{"
"0","    nodes = state_nodes %>%"
"0","      select(county, city_name, lat, lon) %>%"
"0","      rename(y = lat, x = lon) %>%"
"0","      distinct()"
"0","    edges = state_edges %>%"
"0","      select(county1, county2, dist) %>%"
"0","      distinct()"
"0","    graph = graph_from_data_frame(d = edges, vertices = nodes, directed = FALSE)"
"0","    return(graph)"
"0","  }"
"0","}"
"0",""
"0","roads_by_state = map2(nodes, edges[1:(length(edges) - 1)], create_state_graph)"
"0",""
"0","nodes_global = bind_rows(imap_dfr(nodes, ~ .x %>%"
"0","  mutate(county = paste(.y, .x$county, sep = "" - "")) %>%"
"0","  select(county, city_name, lat, lon) %>%"
"0","  distinct()))"
"0",""
"0","edges_global = bind_rows(imap_dfr(edges[1:(length(edges) - 1)], ~ {"
"0","    if(nrow(.x) > 0){"
"0","      .x %>%"
"0","        mutate(county1 = paste(.y, .x$county1, sep = "" - ""),"
"0","               county2 = paste(.y, .x$county2, sep = "" - "")) %>%"
"0","        select(county1, county2, dist) %>%"
"0","        distinct()"
"0","    }else{"
"0","      data.frame(county1 = character(0), county2 = character(0), dist = numeric(0))"
"0","    }"
"0","  }),"
"0","  bind_rows("
"0","    edges$global %>%"
"0","      mutate(county1 = paste(.data$state1, .data$county1, sep = "" - ""),"
"0","             county2 = paste(.data$state2, .data$county2, sep = "" - "")) %>%"
"0","      select(county1, county2, dist) %>%"
"0","      distinct()"
"0","  ))"
"0",""
"0","roads = create_state_graph(nodes_global, edges_global)"
"0",""
"0","roads_by_state_nodes = nodes"
"0","roads_by_state_edges = edges"
"0","roads_nodes = nodes_global"
"0","roads_edges = edges_global"
"0","rm(nodes)"
"0","rm(edges)"
"0","rm(nodes_global)"
"0","rm(edges_global)"
"0",""
"0","for(state in names(roads_by_state)){"
"0","  print("
"0","    ggraph(roads_by_state[[state]], layout = 'manual', x = roads_by_state_nodes[[state]]$x, y = roads_by_state_nodes[[state]]$y) +"
"0","      geom_edge_link(aes(width = 1), alpha = 0.6) +"
"0","      geom_node_point() +"
"0","      geom_node_text(aes(label = name), vjust = 1.5, hjust = 1) +"
"0","      ggtitle(state) +"
"0","      theme_minimal() +"
"0","      guides(edge_width = ""none"")"
"0","  )"
"0","}"
